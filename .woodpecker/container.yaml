# DO NOT EDIT
# Generated from .copier-answers.yml


matrix:
  ARCH:
    - amd64
    - arm64

labels:
  platform: linux/${ARCH}

clone:
  - name: clone-deep
    image: woodpeckerci/plugin-git
    settings:
      tags: true
      partial: false

variables:
  - &settings
    repo: codeberg.org/${CI_REPO_OWNER}/slidge-whatsapp
    username: ${CI_REPO_OWNER}
    password:
      from_secret: CODEBERG_TOKEN
    registry: codeberg.org
    target: slidge-whatsapp
    # this only caches one of the two platforms unfortunately
    # https://github.com/docker/buildx/discussions/1382
    # https://github.com/docker/buildx/issues/1044
    cache_images:
      - codeberg.org/${CI_REPO_OWNER}/slidge-whatsapp:buildcache-${ARCH}

  - &paths
    - "slidge_whatsapp/**"
    - Dockerfile
    - pyproject.toml
    - .woodpecker/container.yaml

when:
  - event: tag
  - event: push
    path: *paths
  - event: cron
    cron: container-main
  - event: cron
    cron: container-latest

steps:
  build-tag:
    image: woodpeckerci/plugin-docker-buildx:6.0.2
    when:
      event: [tag]
    settings:
      <<: *settings
      build_args:
        SLIDGE_USE_LOCKFILE: "1"
      tags:
        - latest-${ARCH}
        - ${CI_COMMIT_TAG}-${ARCH}

  build-branch:
    when:
      - event: push
        path: *paths
      - event: cron
        cron: container-main
    image: woodpeckerci/plugin-docker-buildx:6.0.2
    settings:
      <<: *settings
      build_args:
        SLIDGE_PRERELEASE: "1"
      tags:
        - ${CI_COMMIT_BRANCH}-${ARCH}

  build-ci:
    when:
        path: *paths
        branch: ${CI_REPO_DEFAULT_BRANCH}
    image: woodpeckerci/plugin-docker-buildx:6.0.2
    settings:
      <<: *settings
      build_args:
        SLIDGE_USE_LOCKFILE: "1"
      target: ci
      tag: ci-${ARCH}
      cache_images:
        - codeberg.org/${CI_REPO_OWNER}/slidge-whatsapp:buildcache-ci-${ARCH}

  checkout-latest-tag:
    image: woodpeckerci/plugin-git
    when:
      - event: cron
        cron: container-latest
    commands:
      - export TAG=$(git describe --tags --abbrev=0)
      - git checkout $TAG
      - git reset --hard
      - echo latest-${ARCH} > .tags

  rebuild-tag:
    image: woodpeckerci/plugin-docker-buildx:6.0.2
    when:
      - event: cron
        cron: container-latest
    settings:
      <<: *settings
